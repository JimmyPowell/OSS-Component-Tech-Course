# 开源课程平台部署文档

## 概述

本文档详细说明了如何将开源课程平台部署到生产环境，包括前端、后端和管理端的完整配置。

**目标域名配置：**
- 前端用户界面：https://www.opendevcourse.com
- 后端API服务：https://backend.opendevcourse.com  
- 管理员界面：https://admin.opendevcourse.com

## 部署架构

```
┌─────────────────────────────────────────────────────┐
│                  Nginx 反向代理                        │
├─────────────────────────────────────────────────────┤
│  www.opendevcourse.com     → Frontend (Vue.js)     │
│  admin.opendevcourse.com   → Admin Panel (Vue.js)  │
│  backend.opendevcourse.com → FastAPI Backend       │
└─────────────────────────────────────────────────────┘
```

## 前期准备

### 1. 服务器要求
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ 或其他Linux发行版
- **内存**: 最少4GB RAM（推荐8GB）
- **存储**: 最少20GB磁盘空间
- **网络**: 公网IP地址，开放80、443端口

### 2. 域名配置
确保以下DNS记录指向您的服务器IP：
```
A     www.opendevcourse.com        → YOUR_SERVER_IP
A     admin.opendevcourse.com      → YOUR_SERVER_IP  
A     backend.opendevcourse.com    → YOUR_SERVER_IP
```

### 3. 必要软件安装
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装基础软件
sudo apt install -y nginx git curl wget

# 安装Node.js (v18+)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 安装Python 3.9+
sudo apt install -y python3 python3-pip python3-venv

# 安装MySQL
sudo apt install -y mysql-server mysql-client

# 安装Redis
sudo apt install -y redis-server

# 安装SSL证书工具
sudo apt install -y certbot python3-certbot-nginx
```

## 后端部署 (backend.opendevcourse.com)

### 1. 代码准备
```bash
# 克隆代码到服务器
cd /opt
sudo git clone https://github.com/your-username/OSS-Component-Tech-Course.git
sudo chown -R $USER:$USER OSS-Component-Tech-Course
cd OSS-Component-Tech-Course/backend
```

### 2. 环境配置

**修改 `.env` 文件：**
```bash
# MySQL Configuration
MYSQL_USER="root"
MYSQL_PASSWORD="your_secure_password"
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_DB="opendevcourse_db"

# Redis Configuration  
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# JWT Configuration
JWT_SECRET_KEY="your_production_secret_key_minimum_32_characters"
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7

# Email Configuration
MAIL_HOST=smtp.qq.com
MAIL_PORT=465
MAIL_USERNAME=your_email@qq.com
MAIL_PASSWORD=your_email_password
MAIL_FROM=your_email@qq.com
MAIL_TLS=False
MAIL_SSL=True

# Qiniu Cloud Storage Configuration
QINIU_ACCESS_KEY="your_qiniu_access_key"
QINIU_SECRET_KEY="your_qiniu_secret_key"
QINIU_BUCKET="your_bucket_name"
QINIU_UPLOAD_DOMAIN="https://up-z1.qiniup.com"
QINIU_DOWNLOAD_DOMAIN="https://your_domain.com"

# Logging Configuration
LOG_LEVEL=INFO
LOG_FILE_PATH=/opt/OSS-Component-Tech-Course/backend/logs
LOG_MAX_SIZE=50MB
LOG_BACKUP_COUNT=30
```

**重要修改点：**
1. 更改MySQL密码为强密码
2. 更改JWT密钥为强密钥（最少32字符）
3. 更新邮箱配置为您的实际邮箱
4. 更新七牛云存储配置
5. 日志路径使用绝对路径

### 3. 后端CORS配置修改

**修改 `backend/app/main.py`：**

将CORS origins更新为生产域名：
```python
# CORS Middleware
origins = [
    "https://www.opendevcourse.com",      # 用户前端
    "https://admin.opendevcourse.com",    # 管理前端
    "http://localhost:5173",              # 开发环境（可选保留）
    "http://127.0.0.1:5173",
    "http://localhost:5174",
    "http://127.0.0.1:5174",
]
```

### 4. 数据库初始化
```bash
# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 创建数据库
sudo mysql -u root -p
CREATE DATABASE opendevcourse_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
GRANT ALL PRIVILEGES ON opendevcourse_db.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 导入数据库结构
mysql -u root -p opendevcourse_db < /opt/OSS-Component-Tech-Course/sql/schema.sql
```

### 5. Python环境配置
```bash
cd /opt/OSS-Component-Tech-Course/backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 创建日志目录
mkdir -p logs
sudo chown -R www-data:www-data logs
```

### 6. 系统服务配置

**创建 `/etc/systemd/system/opendevcourse-backend.service`：**
```ini
[Unit]
Description=OpenDevCourse FastAPI Backend
After=network.target

[Service]
Type=exec
User=www-data
Group=www-data
WorkingDirectory=/opt/OSS-Component-Tech-Course/backend
Environment=PATH=/opt/OSS-Component-Tech-Course/backend/venv/bin
ExecStart=/opt/OSS-Component-Tech-Course/backend/venv/bin/uvicorn app.main:app --host 127.0.0.1 --port 8000
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

**启动后端服务：**
```bash
sudo systemctl daemon-reload
sudo systemctl enable opendevcourse-backend
sudo systemctl start opendevcourse-backend
sudo systemctl status opendevcourse-backend
```

## 前端部署

### 1. 用户前端 (www.opendevcourse.com)

**修改API配置文件 `frontend/src/api/index.js`：**
```javascript
const apiClient = axios.create({
  baseURL: 'https://backend.opendevcourse.com/api/v1',
  headers: {
    'Content-Type': 'application/json',
  },
});
```

**修改硬编码API地址 `frontend/src/views/ProfilePage.vue`：**
将所有 `http://localhost:8000` 替换为 `https://backend.opendevcourse.com`：
- `https://backend.opendevcourse.com/api/v1/auth/me`
- `https://backend.opendevcourse.com/api/v1/auth/profile`
- `https://backend.opendevcourse.com/api/v1/auth/change-password`

**构建前端：**
```bash
cd /opt/OSS-Component-Tech-Course/frontend
npm install
npm run build

# 部署到nginx目录
sudo mkdir -p /var/www/opendevcourse.com
sudo cp -r dist/* /var/www/opendevcourse.com/
sudo chown -R www-data:www-data /var/www/opendevcourse.com
```

### 2. 管理前端 (admin.opendevcourse.com)

**修改所有组件中的API配置：**

需要在以下文件中将 `http://localhost:8000` 替换为 `https://backend.opendevcourse.com`：

1. `frontend-admin/src/utils/request.js`
2. `frontend-admin/src/components/ShowcaseDiscussionManagement.vue`
3. `frontend-admin/src/components/Navbar.vue`
4. `frontend-admin/src/components/ShowcaseReview.vue`
5. `frontend-admin/src/components/ShowcaseManagement.vue`
6. `frontend-admin/src/components/ForumPostManagement.vue`
7. `frontend-admin/src/components/PptManagement.vue`
8. `frontend-admin/src/components/Login.vue`
9. `frontend-admin/src/components/VideoManagement.vue`
10. `frontend-admin/src/components/ForumManagement.vue`
11. `frontend-admin/src/components/UserManagement.vue`
12. `frontend-admin/src/components/HomeworkManagement.vue`
13. `frontend-admin/src/components/AnnouncementManagement.vue`

**批量替换命令：**
```bash
cd /opt/OSS-Component-Tech-Course/frontend-admin
find src/ -name "*.vue" -o -name "*.js" | xargs sed -i 's|http://localhost:8000|https://backend.opendevcourse.com|g'
```

**构建管理前端：**
```bash
npm install
npm run build

# 部署到nginx目录
sudo mkdir -p /var/www/admin.opendevcourse.com
sudo cp -r dist/* /var/www/admin.opendevcourse.com/
sudo chown -R www-data:www-data /var/www/admin.opendevcourse.com
```

## Nginx配置

### 1. 创建配置文件

**创建 `/etc/nginx/sites-available/opendevcourse`：**
```nginx
# 用户前端 - www.opendevcourse.com
server {
    listen 80;
    server_name www.opendevcourse.com opendevcourse.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name www.opendevcourse.com opendevcourse.com;

    ssl_certificate /etc/letsencrypt/live/www.opendevcourse.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.opendevcourse.com/privkey.pem;
    
    root /var/www/opendevcourse.com;
    index index.html;

    # Vue.js SPA配置
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# 管理前端 - admin.opendevcourse.com
server {
    listen 80;
    server_name admin.opendevcourse.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name admin.opendevcourse.com;

    ssl_certificate /etc/letsencrypt/live/admin.opendevcourse.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/admin.opendevcourse.com/privkey.pem;
    
    root /var/www/admin.opendevcourse.com;
    index index.html;

    # Vue.js SPA配置
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# 后端API - backend.opendevcourse.com
server {
    listen 80;
    server_name backend.opendevcourse.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name backend.opendevcourse.com;

    ssl_certificate /etc/letsencrypt/live/backend.opendevcourse.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/backend.opendevcourse.com/privkey.pem;

    # API请求转发到FastAPI
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS头部（作为备份，主要由FastAPI处理）
        add_header Access-Control-Allow-Origin "https://www.opendevcourse.com,https://admin.opendevcourse.com" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        
        # 处理预检请求
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    # 文件上传大小限制
    client_max_body_size 100M;
}
```

### 2. 激活配置
```bash
sudo ln -s /etc/nginx/sites-available/opendevcourse /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## SSL证书配置

### 1. 获取Let's Encrypt证书
```bash
# 为所有域名申请证书
sudo certbot --nginx -d www.opendevcourse.com -d opendevcourse.com
sudo certbot --nginx -d admin.opendevcourse.com  
sudo certbot --nginx -d backend.opendevcourse.com

# 设置自动续期
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

### 2. 验证证书
```bash
sudo certbot certificates
```

## 代码修改清单

### 1. 后端修改 (侵入性：低)

**文件：`backend/app/main.py`**
```python
# 更新CORS配置
origins = [
    "https://www.opendevcourse.com",
    "https://admin.opendevcourse.com",
]
```

**文件：`backend/.env`**
- 更新所有配置为生产环境值
- 使用强密码和密钥
- 更新日志路径为绝对路径

### 2. 前端修改 (侵入性：中等)

**主要修改：**
- **用户前端**：1个文件需要修改API baseURL
- **管理前端**：13个组件文件需要批量替换API地址

**批量修改脚本：**
```bash
# 用户前端API配置
sed -i "s|http://127.0.0.1:8000|https://backend.opendevcourse.com|g" \
    frontend/src/api/index.js

# 用户前端其他硬编码地址
sed -i "s|http://localhost:8000|https://backend.opendevcourse.com|g" \
    frontend/src/views/ProfilePage.vue

# 管理前端批量替换
find frontend-admin/src/ -name "*.vue" -o -name "*.js" | \
    xargs sed -i 's|http://localhost:8000|https://backend.opendevcourse.com|g'
```

## 数据库部署

### 1. MySQL配置
```bash
# 安全配置
sudo mysql_secure_installation

# 创建生产数据库
sudo mysql -u root -p
CREATE DATABASE opendevcourse_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 导入数据库结构
mysql -u root -p opendevcourse_db < sql/schema.sql
```

### 2. Redis配置
```bash
# 启动Redis服务
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 验证Redis连接
redis-cli ping
```

## 部署流程

### 1. 完整部署脚本
```bash
#!/bin/bash

# 设置变量
PROJECT_DIR="/opt/OSS-Component-Tech-Course"
BACKEND_DIR="$PROJECT_DIR/backend"
FRONTEND_DIR="$PROJECT_DIR/frontend"
ADMIN_DIR="$PROJECT_DIR/frontend-admin"

echo "开始部署开源课程平台..."

# 1. 停止现有服务
sudo systemctl stop opendevcourse-backend 2>/dev/null || true

# 2. 更新代码
cd $PROJECT_DIR
git pull origin main

# 3. 修改API地址
echo "更新API配置..."
sed -i "s|http://127.0.0.1:8000|https://backend.opendevcourse.com|g" $FRONTEND_DIR/src/api/index.js
sed -i "s|http://localhost:8000|https://backend.opendevcourse.com|g" $FRONTEND_DIR/src/views/ProfilePage.vue
find $ADMIN_DIR/src/ -name "*.vue" -o -name "*.js" | xargs sed -i 's|http://localhost:8000|https://backend.opendevcourse.com|g'

# 4. 构建前端
echo "构建用户前端..."
cd $FRONTEND_DIR
npm install
npm run build
sudo cp -r dist/* /var/www/opendevcourse.com/

echo "构建管理前端..."  
cd $ADMIN_DIR
npm install
npm run build
sudo cp -r dist/* /var/www/admin.opendevcourse.com/

# 5. 更新后端
echo "更新后端依赖..."
cd $BACKEND_DIR
source venv/bin/activate
pip install -r requirements.txt

# 6. 重启服务
sudo systemctl start opendevcourse-backend
sudo systemctl reload nginx

echo "部署完成！"
echo "用户前端: https://www.opendevcourse.com"
echo "管理前端: https://admin.opendevcourse.com"  
echo "后端API: https://backend.opendevcourse.com"
```

### 2. 服务管理命令
```bash
# 查看后端服务状态
sudo systemctl status opendevcourse-backend

# 查看后端日志
sudo journalctl -u opendevcourse-backend -f

# 查看应用日志
tail -f /opt/OSS-Component-Tech-Course/backend/logs/app.log

# 重启所有服务
sudo systemctl restart opendevcourse-backend nginx
```

## 监控和维护

### 1. 日志监控
```bash
# 应用日志位置
/opt/OSS-Component-Tech-Course/backend/logs/
├── app.log          # 应用日志
├── access.log       # HTTP访问日志  
└── error.log        # 错误日志

# 系统日志
sudo journalctl -u opendevcourse-backend
sudo journalctl -u nginx
```

### 2. 备份策略
```bash
# 数据库备份脚本
#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
mysqldump -u root -p opendevcourse_db > $BACKUP_DIR/db_backup_$DATE.sql
gzip $BACKUP_DIR/db_backup_$DATE.sql

# 保留最近30天的备份
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +30 -delete
```

### 3. 性能优化建议
- **Nginx**: 启用gzip压缩，配置静态资源缓存
- **数据库**: 定期优化数据库，设置合适的索引
- **Redis**: 监控内存使用，设置合适的过期策略
- **日志**: 定期清理老旧日志文件

## 故障排查

### 1. 常见问题

**后端服务无法启动：**
```bash
# 检查端口占用
sudo lsof -i :8000

# 检查权限
ls -la /opt/OSS-Component-Tech-Course/backend/logs/

# 检查环境变量
cd /opt/OSS-Component-Tech-Course/backend && source venv/bin/activate && python -c "from app.config.settings import settings; print(settings.MYSQL_HOST)"
```

**前端页面无法访问：**
```bash
# 检查nginx配置
sudo nginx -t

# 检查文件权限
ls -la /var/www/opendevcourse.com/

# 检查SSL证书
sudo certbot certificates
```

**数据库连接失败：**
```bash
# 检查MySQL服务
sudo systemctl status mysql

# 测试数据库连接
mysql -u root -p -e "SHOW DATABASES;"
```

### 2. 健康检查

**后端健康检查：**
```bash
curl -k https://backend.opendevcourse.com/
curl -k https://backend.opendevcourse.com/api/v1/auth/
```

**前端健康检查：**
```bash
curl -I https://www.opendevcourse.com
curl -I https://admin.opendevcourse.com
```

## 安全注意事项

### 1. 生产环境安全
- 使用强密码和密钥
- 定期更新系统和依赖包
- 配置防火墙，只开放必要端口
- 定期备份数据库和重要文件
- 监控异常访问和错误日志

### 2. 配置检查清单
- [ ] MySQL密码已修改为强密码
- [ ] JWT密钥已修改为强密钥
- [ ] 邮箱配置已更新
- [ ] 七牛云配置已更新
- [ ] CORS配置已更新为生产域名
- [ ] 所有API地址已替换为生产地址
- [ ] SSL证书已正确配置
- [ ] 防火墙已正确配置

## 预估时间和复杂度

### 完成时间预估
- **代码修改**: 30-45分钟（低复杂度）
- **服务器环境搭建**: 1-2小时（中等复杂度）
- **SSL证书配置**: 15-30分钟（低复杂度）
- **测试和验证**: 30-45分钟（中等复杂度）
- **总计**: 2.5-3.5小时

### 侵入性评估
- **低侵入性**: 后端CORS配置修改
- **中等侵入性**: 前端API地址批量替换
- **高侵入性**: 无

### 风险评估
- **低风险**: 配置文件修改，易于回滚
- **中等风险**: 域名切换，需要DNS传播时间
- **注意**: 建议在测试环境先完整验证一遍流程

## 最佳实践建议

1. **分阶段部署**: 先部署后端，再部署前端，最后配置SSL
2. **备份优先**: 部署前备份现有数据和配置
3. **监控部署**: 部署过程中持续监控服务状态
4. **回滚准备**: 准备快速回滚方案
5. **文档维护**: 部署完成后更新相关文档

---

本文档提供了完整的生产环境部署指南，包含了所有必要的配置修改和部署步骤。建议在实施前仔细阅读并在测试环境验证。